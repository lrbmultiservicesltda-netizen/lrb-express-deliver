<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRB Express Delivery - Sistema de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-pendente { background-color: #FEF3C7; color: #92400E; }
        .status-em-rota { background-color: #DBEAFE; color: #1E40AF; }
        .status-entregue { background-color: #D1FAE5; color: #065F46; }
        .status-problema { background-color: #FEE2E2; color: #991B1B; }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        .loading.active {
            display: block;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }
        .overlay.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div class="overlay" id="overlay"></div>
    <div class="loading" id="loading">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-700 font-semibold">Carregando...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-truck-fast text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">LRB Express Delivery</h1>
                        <p class="text-xs text-blue-100">Multiservices LTDA</p>
                    </div>
                </div>
                <nav class="flex items-center space-x-4">
                    <button onclick="showSection('tracking')" class="px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-search mr-2"></i>Rastreamento
                    </button>
                    <div id="auth-buttons">
                        <button onclick="showSection('login')" class="px-4 py-2 rounded hover:bg-blue-700 transition">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </button>
                    </div>
                    <div id="user-menu" class="hidden">
                        <span id="user-name" class="mr-4"></span>
                        <button onclick="logout()" class="px-4 py-2 rounded bg-red-500 hover:bg-red-600 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>Sair
                        </button>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Login Section -->
    <section id="login-section" class="container mx-auto px-4 py-8 hidden">
        <div class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <i class="fas fa-lock text-5xl text-blue-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Login</h2>
                    <p class="text-gray-600">Acesso restrito para funcionários</p>
                </div>
                
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="login-email" required
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">Senha</label>
                        <input type="password" id="login-password" required
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                </form>
                <div id="login-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm"></div>
            </div>
        </div>
    </section>

    <!-- Tracking Section (Public) -->
    <section id="tracking-section" class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-8">
                    <i class="fas fa-box text-5xl text-blue-600 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Rastreie seu Malote</h2>
                    <p class="text-gray-600">Digite o código de rastreamento para acompanhar sua entrega</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Código de Rastreamento</label>
                    <div class="flex gap-2">
                        <input type="text" id="trackingCode" placeholder="Ex: BRX123456" 
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase">
                        <button onclick="trackPackage()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-search mr-2"></i>Rastrear
                        </button>
                    </div>
                </div>

                <div id="trackingResult" class="hidden">
                    <div class="border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Status da Entrega</h3>
                        <div id="trackingDetails"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Section -->
    <section id="admin-section" class="container mx-auto px-4 py-8 hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-plus-circle text-blue-600 mr-2"></i>
                Cadastrar Nova Entrega
            </h2>
            
            <form onsubmit="createDelivery(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Cliente *</label>
                        <input type="text" id="customerName" required placeholder="Nome do cliente" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Telefone *</label>
                        <input type="text" id="customerPhone" required placeholder="(11) 99999-9999" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">Endereço Completo *</label>
                        <input type="text" id="customerAddress" required placeholder="Rua, número, bairro, cidade - CEP" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Região/Rota *</label>
                        <select id="deliveryRoute" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione...</option>
                            <option value="zona-norte">Zona Norte</option>
                            <option value="zona-sul">Zona Sul</option>
                            <option value="zona-leste">Zona Leste</option>
                            <option value="zona-oeste">Zona Oeste</option>
                            <option value="centro">Centro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Entregador *</label>
                        <select id="deliveryDriver" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-save mr-2"></i>Cadastrar Entrega
                </button>
            </form>
        </div>

        <!-- Deliveries List -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-list text-blue-600 mr-2"></i>
                Todas as Entregas
            </h2>
            <div id="deliveriesList"></div>
        </div>
    </section>

    <!-- Driver Section -->
    <section id="driver-section" class="container mx-auto px-4 py-8 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-truck text-blue-600 mr-2"></i>
                Minhas Entregas
            </h2>
            <div id="driverDeliveries"></div>
        </div>
    </section>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://dxemfmxjpvynfwsrgzwe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4ZW1mbXhqcHZ5bmZ3c3JnendlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MDE1MjgsImV4cCI6MjA4NTM3NzUyOH0.AkIFRQusKfjtrH-nVQQ5DqqFx17tdWdSai6nFbICOko';

        let supabaseClient;
        let currentUser = null;
        let currentUserProfile = null;

        // Inicializar Supabase quando a página carregar
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                // Criar cliente Supabase
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('✅ Supabase inicializado com sucesso!');
                
                // Verificar se há usuário logado
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    await loadUserProfile(session.user);
                }
                
                // Verificar parâmetro de rastreamento na URL
                const urlParams = new URLSearchParams(window.location.search);
                const trackingCode = urlParams.get('code');
                if (trackingCode) {
                    document.getElementById('trackingCode').value = trackingCode;
                    await trackPackage();
                }
            } catch (error) {
                console.error('❌ Erro ao inicializar:', error);
                alert('Erro ao conectar com o servidor. Verifique sua conexão.');
            }
        });

        // Funções de navegação
        function showSection(section) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const overlay = document.getElementById('overlay');
            
            if (show) {
                loading.classList.add('active');
                overlay.classList.add('active');
            } else {
                loading.classList.remove('active');
                overlay.classList.remove('active');
            }
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Autenticação
        async function handleLogin(event) {
            event.preventDefault();
            showLoading(true);

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                await loadUserProfile(data.user);
            } catch (error) {
                showError('login-error', error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadUserProfile(user) {
            try {
                currentUser = user;

                const { data: profile, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error) throw error;

                currentUserProfile = profile;

                // Atualizar UI
                document.getElementById('auth-buttons').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-name').textContent = profile.full_name;

                // Redirecionar para seção apropriada
                if (profile.role === 'admin') {
                    showSection('admin');
                    await loadDrivers();
                    await loadAllDeliveries();
                } else {
                    showSection('driver');
                    await loadDriverDeliveries();
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                alert('Erro ao carregar perfil do usuário');
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentUserProfile = null;

            document.getElementById('auth-buttons').classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
            showSection('tracking');
        }

        // Rastreamento público
        async function trackPackage() {
            const code = document.getElementById('trackingCode').value.trim().toUpperCase();
            
            if (!code) {
                alert('Por favor, digite um código de rastreamento');
                return;
            }

            showLoading(true);

            try {
                const { data: delivery, error } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .eq('tracking_code', code)
                    .single();

                if (error || !delivery) {
                    showTrackingError();
                    return;
                }

                // Buscar histórico
                const { data: updates } = await supabaseClient
                    .from('delivery_updates')
                    .select('*')
                    .eq('delivery_id', delivery.id)
                    .order('created_at', { ascending: false });

                showTrackingResult(delivery, updates || []);
            } catch (error) {
                console.error('Erro ao rastrear:', error);
                showTrackingError();
            } finally {
                showLoading(false);
            }
        }

        function showTrackingResult(delivery, updates) {
            const statusMap = {
                'pendente': 'Pendente',
                'em-rota': 'Em Rota',
                'entregue': 'Entregue',
                'problema': 'Problema na Entrega'
            };

            const resultDiv = document.getElementById('trackingResult');
            const detailsDiv = document.getElementById('trackingDetails');

            detailsDiv.innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Código</p>
                            <p class="text-lg font-bold font-mono">${delivery.tracking_code}</p>
                        </div>
                        <span class="status-badge status-${delivery.status}">
                            ${statusMap[delivery.status]}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-600">Destinatário</p>
                            <p class="font-semibold">${delivery.customer_name}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Telefone</p>
                            <p class="font-semibold">${delivery.customer_phone}</p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-sm text-gray-600">Endereço</p>
                            <p class="font-semibold">${delivery.customer_address}</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-gray-800 mb-3">Histórico de Movimentação</h4>
                    <div class="space-y-3">
                        ${updates.map((update, index) => `
                            <div class="flex gap-3 ${index !== updates.length - 1 ? 'border-l-2 border-gray-300 pb-3 ml-2' : 'ml-2'}">
                                <div class="flex-shrink-0 w-4 h-4 rounded-full ${
                                    update.status === 'entregue' ? 'bg-green-500' : 
                                    update.status === 'em-rota' ? 'bg-blue-500' : 
                                    update.status === 'problema' ? 'bg-red-500' : 
                                    'bg-yellow-500'
                                } -ml-2.5"></div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${update.description}</p>
                                    <p class="text-sm text-gray-600">${new Date(update.created_at).toLocaleString('pt-BR')}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        function showTrackingError() {
            const resultDiv = document.getElementById('trackingResult');
            const detailsDiv = document.getElementById('trackingDetails');

            detailsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-2"></i>
                    <p class="text-red-700 font-semibold">Código não encontrado</p>
                    <p class="text-red-600 text-sm">Verifique se digitou corretamente</p>
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        // Admin - Carregar entregadores
        async function loadDrivers() {
            try {
                const { data: drivers } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('role', 'entregador')
                    .eq('is_active', true);

                const select = document.getElementById('deliveryDriver');
                select.innerHTML = '<option value="">Selecione...</option>';

                drivers?.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id;
                    option.textContent = driver.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar entregadores:', error);
            }
        }

        // Admin - Criar entrega
        async function createDelivery(event) {
            event.preventDefault();
            showLoading(true);

            try {
                const driverId = document.getElementById('deliveryDriver').value;
                const driverName = document.getElementById('deliveryDriver').selectedOptions[0].text;

                // Gerar código
                const { data: codeData } = await supabaseClient.rpc('generate_tracking_code');
                const trackingCode = codeData;

                // Inserir entrega
                const { data: delivery, error } = await supabaseClient
                    .from('deliveries')
                    .insert([{
                        tracking_code: trackingCode,
                        customer_name: document.getElementById('customerName').value,
                        customer_phone: document.getElementById('customerPhone').value,
                        customer_address: document.getElementById('customerAddress').value,
                        route: document.getElementById('deliveryRoute').value,
                        driver_id: driverId,
                        driver_name: driverName,
                        status: 'pendente'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Criar primeiro update
                await supabaseClient
                    .from('delivery_updates')
                    .insert([{
                        delivery_id: delivery.id,
                        status: 'pendente',
                        description: 'Malote recebido na base',
                        created_by: currentUser.id
                    }]);

                alert(`✅ Entrega cadastrada com sucesso!\n\nCódigo: ${trackingCode}`);

                // Limpar formulário
                event.target.reset();

                // Recarregar lista
                await loadAllDeliveries();
            } catch (error) {
                console.error('Erro ao criar entrega:', error);
                alert('Erro ao criar entrega: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Admin - Listar entregas
        async function loadAllDeliveries() {
            try {
                const { data: deliveries } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .order('created_at', { ascending: false });

                renderDeliveriesList(deliveries || []);
            } catch (error) {
                console.error('Erro ao carregar entregas:', error);
            }
        }

        function renderDeliveriesList(deliveries) {
            const listDiv = document.getElementById('deliveriesList');

            if (deliveries.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma entrega cadastrada</p>';
                return;
            }

            const statusMap = {
                'pendente': 'Pendente',
                'em-rota': 'Em Rota',
                'entregue': 'Entregue',
                'problema': 'Problema'
            };

            listDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Código</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Endereço</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Entregador</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${deliveries.map(delivery => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-mono text-sm font-semibold">${delivery.tracking_code}</td>
                                    <td class="px-4 py-3">${delivery.customer_name}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${delivery.customer_address.substring(0, 40)}...</td>
                                    <td class="px-4 py-3">${delivery.driver_name || '-'}</td>
                                    <td class="px-4 py-3">
                                        <span class="status-badge status-${delivery.status}">
                                            ${statusMap[delivery.status]}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm">${new Date(delivery.created_at).toLocaleDateString('pt-BR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Driver - Minhas entregas
        async function loadDriverDeliveries() {
            try {
                const { data: deliveries } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .eq('driver_id', currentUser.id)
                    .neq('status', 'entregue')
                    .order('created_at', { ascending: false });

                renderDriverDeliveries(deliveries || []);
            } catch (error) {
                console.error('Erro ao carregar entregas:', error);
            }
        }

        function renderDriverDeliveries(deliveries) {
            const driverDiv = document.getElementById('driverDeliveries');

            if (deliveries.length === 0) {
                driverDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma entrega pendente</p>';
                return;
            }

            driverDiv.innerHTML = deliveries.map(delivery => `
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm text-gray-600">Código</p>
                            <p class="font-mono font-bold text-lg">${delivery.tracking_code}</p>
                        </div>
                        <span class="status-badge status-${delivery.status}">
                            ${delivery.status === 'pendente' ? 'Pendente' : 'Em Rota'}
                        </span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <p><span class="font-semibold">Cliente:</span> ${delivery.customer_name}</p>
                        <p><span class="font-semibold">Telefone:</span> <a href="tel:${delivery.customer_phone}" class="text-blue-600 hover:underline">${delivery.customer_phone}</a></p>
                        <p><span class="font-semibold">Endereço:</span> ${delivery.customer_address}</p>
                    </div>
                    
                    <!-- Botões de Navegação -->
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="openInGoogleMaps('${delivery.customer_address.replace(/'/g, "\\'")}')" 
                                class="bg-white border-2 border-blue-500 text-blue-600 px-4 py-2 rounded hover:bg-blue-50 flex items-center justify-center">
                            <i class="fas fa-map-marked-alt mr-2"></i>Google Maps
                        </button>
                        <button onclick="openInWaze('${delivery.customer_address.replace(/'/g, "\\'")}')" 
                                class="bg-white border-2 border-cyan-500 text-cyan-600 px-4 py-2 rounded hover:bg-cyan-50 flex items-center justify-center">
                            <i class="fas fa-route mr-2"></i>Waze
                        </button>
                    </div>
                    
                    <!-- Botões de Status -->
                    <div class="flex gap-2">
                        ${delivery.status === 'pendente' ? `
                            <button onclick="updateDeliveryStatus('${delivery.id}', '${delivery.tracking_code}', 'em-rota')" 
                                    class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                <i class="fas fa-truck mr-2"></i>Iniciar Entrega
                            </button>
                        ` : `
                            <button onclick="updateDeliveryStatus('${delivery.id}', '${delivery.tracking_code}', 'entregue')" 
                                    class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>Confirmar Entrega
                            </button>
                            <button onclick="updateDeliveryStatus('${delivery.id}', '${delivery.tracking_code}', 'problema')" 
                                    class="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                <i class="fas fa-times mr-2"></i>Problema
                            </button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        // Atualizar status
        async function updateDeliveryStatus(deliveryId, trackingCode, newStatus) {
            showLoading(true);

            try {
                const statusDescriptions = {
                    'em-rota': 'Saiu para entrega',
                    'entregue': 'Entregue ao destinatário',
                    'problema': 'Problema na entrega - aguardando solução'
                };

                // Atualizar status
                const { error: updateError } = await supabaseClient
                    .from('deliveries')
                    .update({ status: newStatus })
                    .eq('id', deliveryId);

                if (updateError) throw updateError;

                // Adicionar ao histórico
                await supabaseClient
                    .from('delivery_updates')
                    .insert([{
                        delivery_id: deliveryId,
                        status: newStatus,
                        description: statusDescriptions[newStatus],
                        created_by: currentUser.id
                    }]);

                alert(`✅ Status atualizado para: ${statusDescriptions[newStatus]}`);

                // Recarregar
                if (currentUserProfile.role === 'admin') {
                    await loadAllDeliveries();
                } else {
                    await loadDriverDeliveries();
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status');
            } finally {
                showLoading(false);
            }
        }

        // Funções de Navegação
        function openInGoogleMaps(address) {
            // Codificar o endereço para URL
            const encodedAddress = encodeURIComponent(address);
            
            // Detectar se é mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // No mobile, tenta abrir o app do Google Maps
                window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            } else {
                // No desktop, abre em nova aba
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`, '_blank');
            }
        }

        function openInWaze(address) {
            // Codificar o endereço para URL
            const encodedAddress = encodeURIComponent(address);
            
            // Detectar se é mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // No mobile, tenta abrir o app do Waze
                window.location.href = `https://waze.com/ul?q=${encodedAddress}&navigate=yes`;
            } else {
                // No desktop, abre em nova aba
                window.open(`https://waze.com/ul?q=${encodedAddress}`, '_blank');
            }
        }
    </script>
</body>
</html>