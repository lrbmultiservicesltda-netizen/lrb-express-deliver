<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRB Express Delivery - Sistema de Gest√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-pendente { background-color: #FEF3C7; color: #92400E; }
        .status-em-rota { background-color: #DBEAFE; color: #1E40AF; }
        .status-entregue { background-color: #D1FAE5; color: #065F46; }
        .status-problema { background-color: #FEE2E2; color: #991B1B; }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        .loading.active {
            display: block;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }
        .overlay.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div class="overlay" id="overlay"></div>
    <div class="loading" id="loading">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-700 font-semibold">Carregando...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-truck-fast text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">LRB Express Delivery</h1>
                        <p class="text-xs text-blue-100">Multiservices LTDA</p>
                    </div>
                </div>
                <nav class="flex items-center space-x-4">
                    <button onclick="showSection('tracking')" class="px-4 py-2 rounded hover:bg-blue-700 transition">
                        <i class="fas fa-search mr-2"></i>Rastreamento
                    </button>
                    <div id="auth-buttons">
                        <button onclick="showSection('login')" class="px-4 py-2 rounded hover:bg-blue-700 transition">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </button>
                    </div>
                    <div id="user-menu" class="hidden">
                        <span id="user-name" class="mr-4"></span>
                        <button onclick="logout()" class="px-4 py-2 rounded bg-red-500 hover:bg-red-600 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>Sair
                        </button>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Login Section -->
    <section id="login-section" class="container mx-auto px-4 py-8 hidden">
        <div class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-6">
                    <i class="fas fa-lock text-5xl text-blue-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Login</h2>
                    <p class="text-gray-600">Acesso restrito para funcion√°rios</p>
                </div>
                
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="login-email" required
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">Senha</label>
                        <input type="password" id="login-password" required
                               class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                </form>
                <div id="login-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm"></div>
            </div>
        </div>
    </section>

    <!-- Tracking Section (Public) -->
    <section id="tracking-section" class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-8">
                    <i class="fas fa-box text-5xl text-blue-600 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Rastreie seu Malote</h2>
                    <p class="text-gray-600">Digite o c√≥digo de rastreamento para acompanhar sua entrega</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">C√≥digo de Rastreamento</label>
                    <div class="flex gap-2">
                        <input type="text" id="trackingCode" placeholder="Ex: BRX123456" 
                               class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase">
                        <button onclick="trackPackage()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-search mr-2"></i>Rastrear
                        </button>
                    </div>
                </div>

                <div id="trackingResult" class="hidden">
                    <div class="border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Status da Entrega</h3>
                        <div id="trackingDetails"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Section -->
    <section id="admin-section" class="container mx-auto px-4 py-8 hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-plus-circle text-blue-600 mr-2"></i>
                Cadastrar Nova Entrega
            </h2>
            
            <form onsubmit="createDelivery(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Cliente *</label>
                        <input type="text" id="customerName" required placeholder="Nome do cliente" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Telefone *</label>
                        <input type="text" id="customerPhone" required placeholder="(11) 99999-9999" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2">Endere√ßo Completo *</label>
                        <input type="text" id="customerAddress" required placeholder="Rua, n√∫mero, bairro, cidade - CEP" 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Regi√£o/Rota *</label>
                        <select id="deliveryRoute" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione...</option>
                            <option value="zona-norte">Zona Norte</option>
                            <option value="zona-sul">Zona Sul</option>
                            <option value="zona-leste">Zona Leste</option>
                            <option value="zona-oeste">Zona Oeste</option>
                            <option value="centro">Centro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Entregador *</label>
                        <select id="deliveryDriver" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-save mr-2"></i>Cadastrar Entrega
                    </button>
                    <button type="button" onclick="openImportModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-file-excel mr-2"></i>Importar Planilha
                    </button>
                    <button type="button" onclick="downloadTemplate()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-download mr-2"></i>Baixar Template
                    </button>
                </div>
            </form>
        </div>

        <!-- Deliveries List -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-list text-blue-600 mr-2"></i>
                Todas as Entregas
            </h2>
            <div id="deliveriesList"></div>
        </div>
    </section>

    <!-- Driver Section -->
    <section id="driver-section" class="container mx-auto px-4 py-8 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-truck text-blue-600 mr-2"></i>
                Minhas Entregas
            </h2>
            <div id="driverDeliveries"></div>
        </div>
    </section>

    <!-- Modal de Confirma√ß√£o de Entrega -->
    <div id="deliveryConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        Confirmar Entrega
                    </h3>
                    <button onclick="closeDeliveryModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <form id="deliveryConfirmForm" onsubmit="confirmDelivery(event)">
                    <input type="hidden" id="modalDeliveryId">
                    <input type="hidden" id="modalTrackingCode">

                    <!-- Nome do Recebedor -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Quem recebeu? <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="receiverName" required
                               placeholder="Nome completo"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>

                    <!-- Rela√ß√£o com Destinat√°rio -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Rela√ß√£o com destinat√°rio <span class="text-red-500">*</span>
                        </label>
                        <select id="receiverRelation" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">Selecione...</option>
                            <option value="titular">Titular (pr√≥prio cliente)</option>
                            <option value="filho">Filho(a)</option>
                            <option value="esposo">Esposo(a)</option>
                            <option value="pai-mae">Pai/M√£e</option>
                            <option value="irmao">Irm√£o/Irm√£</option>
                            <option value="vizinho">Vizinho</option>
                            <option value="porteiro">Porteiro/Zelador</option>
                            <option value="funcionario">Funcion√°rio/Recepcionista</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>

                    <!-- Documento -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Documento (RG ou CPF) <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="receiverDocument" required
                               placeholder="000.000.000-00 ou 00.000.000-0"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Digite apenas n√∫meros</p>
                    </div>

                    <!-- Observa√ß√µes -->
                    <div class="mb-6">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Observa√ß√µes (opcional)
                        </label>
                        <textarea id="deliveryNotes" rows="3"
                                  placeholder="Ex: Porteiro do pr√©dio, Recebeu no trabalho..."
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                    </div>

                    <!-- Bot√µes -->
                    <div class="flex gap-3">
                        <button type="button" onclick="closeDeliveryModal()"
                                class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                        <button type="submit"
                                class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                            <i class="fas fa-check mr-2"></i>Confirmar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Importa√ß√£o de Planilha -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-file-excel text-green-600 mr-2"></i>
                        Importar Entregas
                    </h3>
                    <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <!-- Upload Area -->
                <div id="uploadArea" class="mb-6">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition cursor-pointer"
                         onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-4"></i>
                        <p class="text-lg font-semibold text-gray-700 mb-2">Clique para selecionar ou arraste o arquivo</p>
                        <p class="text-sm text-gray-500">Formatos aceitos: .xlsx, .xls, .csv</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)" class="hidden">
                    </div>
                    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-800"><strong>üìã Formato da planilha:</strong></p>
                        <p class="text-xs text-blue-700 mt-2">
                            Colunas: <code class="bg-blue-100 px-2 py-1 rounded">Cliente | Telefone | Endere√ßo | Regi√£o | Entregador</code>
                        </p>
                    </div>
                </div>

                <!-- Preview Area -->
                <div id="previewArea" class="hidden">
                    <div class="mb-4 flex items-center justify-between">
                        <h4 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-eye mr-2"></i>Preview dos Dados
                        </h4>
                        <button onclick="resetImport()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-times mr-1"></i>Cancelar
                        </button>
                    </div>

                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm"><strong>Arquivo:</strong> <span id="fileName"></span></p>
                        <p class="text-sm"><strong>Total de linhas:</strong> <span id="totalRows"></span></p>
                        <p class="text-sm"><strong>V√°lidas:</strong> <span id="validRows" class="text-green-600"></span></p>
                        <p class="text-sm"><strong>Com erro:</strong> <span id="errorRows" class="text-red-600"></span></p>
                    </div>

                    <div class="overflow-x-auto mb-6 max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left">#</th>
                                    <th class="px-3 py-2 text-left">Cliente</th>
                                    <th class="px-3 py-2 text-left">Telefone</th>
                                    <th class="px-3 py-2 text-left">Endere√ßo</th>
                                    <th class="px-3 py-2 text-left">Regi√£o</th>
                                    <th class="px-3 py-2 text-left">Entregador</th>
                                    <th class="px-3 py-2 text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody id="previewTable"></tbody>
                        </table>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="resetImport()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar
                        </button>
                        <button onclick="processImport()" id="importButton" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-upload mr-2"></i>Importar <span id="importCount"></span> Entregas
                        </button>
                    </div>
                </div>

                <!-- Result Area -->
                <div id="resultArea" class="hidden">
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-6xl text-green-600 mb-4"></i>
                        <h4 class="text-2xl font-bold text-gray-800 mb-2">Importa√ß√£o Conclu√≠da!</h4>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 inline-block">
                            <p class="text-lg"><strong id="successCount"></strong> entregas importadas com sucesso</p>
                            <p class="text-sm text-gray-600" id="errorCount"></p>
                        </div>
                        <button onclick="closeImportModal(); location.reload();" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-check mr-2"></i>Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://dxemfmxjpvynfwsrgzwe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4ZW1mbXhqcHZ5bmZ3c3JnendlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MDE1MjgsImV4cCI6MjA4NTM3NzUyOH0.AkIFRQusKfjtrH-nVQQ5DqqFx17tdWdSai6nFbICOko';

        let supabaseClient;
        let currentUser = null;
        let currentUserProfile = null;

        // Inicializar Supabase quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                // Criar cliente Supabase
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase inicializado com sucesso!');
                
                // Verificar se h√° usu√°rio logado
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    await loadUserProfile(session.user);
                }
                
                // Verificar par√¢metro de rastreamento na URL
                const urlParams = new URLSearchParams(window.location.search);
                const trackingCode = urlParams.get('code');
                if (trackingCode) {
                    document.getElementById('trackingCode').value = trackingCode;
                    await trackPackage();
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar:', error);
                alert('Erro ao conectar com o servidor. Verifique sua conex√£o.');
            }
        });

        // Fun√ß√µes de navega√ß√£o
        function showSection(section) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const overlay = document.getElementById('overlay');
            
            if (show) {
                loading.classList.add('active');
                overlay.classList.add('active');
            } else {
                loading.classList.remove('active');
                overlay.classList.remove('active');
            }
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Autentica√ß√£o
        async function handleLogin(event) {
            event.preventDefault();
            showLoading(true);

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                await loadUserProfile(data.user);
            } catch (error) {
                showError('login-error', error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadUserProfile(user) {
            try {
                currentUser = user;

                const { data: profile, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error) throw error;

                currentUserProfile = profile;

                // Atualizar UI
                document.getElementById('auth-buttons').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-name').textContent = profile.full_name;

                // Redirecionar para se√ß√£o apropriada
                if (profile.role === 'admin') {
                    showSection('admin');
                    await loadDrivers();
                    await loadAllDeliveries();
                } else {
                    showSection('driver');
                    await loadDriverDeliveries();
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                alert('Erro ao carregar perfil do usu√°rio');
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentUserProfile = null;

            document.getElementById('auth-buttons').classList.remove('hidden');
            document.getElementById('user-menu').classList.add('hidden');
            showSection('tracking');
        }

        // Rastreamento p√∫blico
        async function trackPackage() {
            const code = document.getElementById('trackingCode').value.trim().toUpperCase();
            
            if (!code) {
                alert('Por favor, digite um c√≥digo de rastreamento');
                return;
            }

            showLoading(true);

            try {
                const { data: delivery, error } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .eq('tracking_code', code)
                    .single();

                if (error || !delivery) {
                    showTrackingError();
                    return;
                }

                // Buscar hist√≥rico
                const { data: updates } = await supabaseClient
                    .from('delivery_updates')
                    .select('*')
                    .eq('delivery_id', delivery.id)
                    .order('created_at', { ascending: false });

                showTrackingResult(delivery, updates || []);
            } catch (error) {
                console.error('Erro ao rastrear:', error);
                showTrackingError();
            } finally {
                showLoading(false);
            }
        }

        function showTrackingResult(delivery, updates) {
            const statusMap = {
                'pendente': 'Pendente',
                'em-rota': 'Em Rota',
                'entregue': 'Entregue',
                'problema': 'Problema na Entrega'
            };

            const resultDiv = document.getElementById('trackingResult');
            const detailsDiv = document.getElementById('trackingDetails');

            detailsDiv.innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-sm text-gray-600">C√≥digo</p>
                            <p class="text-lg font-bold font-mono">${delivery.tracking_code}</p>
                        </div>
                        <span class="status-badge status-${delivery.status}">
                            ${statusMap[delivery.status]}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                        <div>
                            <p class="text-sm text-gray-600">Destinat√°rio</p>
                            <p class="font-semibold">${delivery.customer_name}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Telefone</p>
                            <p class="font-semibold">${delivery.customer_phone}</p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-sm text-gray-600">Endere√ßo</p>
                            <p class="font-semibold">${delivery.customer_address}</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-gray-800 mb-3">Hist√≥rico de Movimenta√ß√£o</h4>
                    <div class="space-y-3">
                        ${updates.map((update, index) => `
                            <div class="flex gap-3 ${index !== updates.length - 1 ? 'border-l-2 border-gray-300 pb-3 ml-2' : 'ml-2'}">
                                <div class="flex-shrink-0 w-4 h-4 rounded-full ${
                                    update.status === 'entregue' ? 'bg-green-500' : 
                                    update.status === 'em-rota' ? 'bg-blue-500' : 
                                    update.status === 'problema' ? 'bg-red-500' : 
                                    'bg-yellow-500'
                                } -ml-2.5"></div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${update.description}</p>
                                    <p class="text-sm text-gray-600">${new Date(update.created_at).toLocaleString('pt-BR')}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        function showTrackingError() {
            const resultDiv = document.getElementById('trackingResult');
            const detailsDiv = document.getElementById('trackingDetails');

            detailsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-2"></i>
                    <p class="text-red-700 font-semibold">C√≥digo n√£o encontrado</p>
                    <p class="text-red-600 text-sm">Verifique se digitou corretamente</p>
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        // Admin - Carregar entregadores
        async function loadDrivers() {
            try {
                const { data: drivers, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('role', 'driver');

                if (error) {
                    console.error('Erro ao buscar entregadores:', error);
                    return;
                }

                const select = document.getElementById('deliveryDriver');
                select.innerHTML = '<option value="">Selecione...</option>';

                drivers?.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id;
                    option.textContent = driver.full_name;
                    select.appendChild(option);
                });
                
                console.log('‚úÖ Entregadores carregados:', drivers);
            } catch (error) {
                console.error('Erro ao carregar entregadores:', error);
            }
        }

        // Admin - Criar entrega
        async function createDelivery(event) {
            event.preventDefault();
            showLoading(true);

            try {
                const driverId = document.getElementById('deliveryDriver').value;
                const driverName = document.getElementById('deliveryDriver').selectedOptions[0].text;

                // Gerar c√≥digo
                const { data: codeData } = await supabaseClient.rpc('generate_tracking_code');
                const trackingCode = codeData;

                // Inserir entrega
                const { data: delivery, error } = await supabaseClient
                    .from('deliveries')
                    .insert([{
                        tracking_code: trackingCode,
                        customer_name: document.getElementById('customerName').value,
                        customer_phone: document.getElementById('customerPhone').value,
                        customer_address: document.getElementById('customerAddress').value,
                        route: document.getElementById('deliveryRoute').value,
                        driver_id: driverId,
                        driver_name: driverName,
                        status: 'pendente'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Criar primeiro update
                await supabaseClient
                    .from('delivery_updates')
                    .insert([{
                        delivery_id: delivery.id,
                        status: 'pendente',
                        description: 'Malote recebido na base',
                        created_by: currentUser.id
                    }]);

                alert(`‚úÖ Entrega cadastrada com sucesso!\n\nC√≥digo: ${trackingCode}`);

                // Limpar formul√°rio
                event.target.reset();

                // Recarregar lista
                await loadAllDeliveries();
            } catch (error) {
                console.error('Erro ao criar entrega:', error);
                alert('Erro ao criar entrega: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Admin - Listar entregas
        async function loadAllDeliveries() {
            try {
                const { data: deliveries } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .order('created_at', { ascending: false });

                renderDeliveriesList(deliveries || []);
            } catch (error) {
                console.error('Erro ao carregar entregas:', error);
            }
        }

        function renderDeliveriesList(deliveries) {
            const listDiv = document.getElementById('deliveriesList');

            if (deliveries.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma entrega cadastrada</p>';
                return;
            }

            const statusMap = {
                'pendente': 'Pendente',
                'em-rota': 'Em Rota',
                'entregue': 'Entregue',
                'problema': 'Problema'
            };

            listDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">C√≥digo</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Endere√ßo</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Entregador</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${deliveries.map(delivery => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-mono text-sm font-semibold">${delivery.tracking_code}</td>
                                    <td class="px-4 py-3">${delivery.customer_name}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${delivery.customer_address.substring(0, 40)}...</td>
                                    <td class="px-4 py-3">${delivery.driver_name || '-'}</td>
                                    <td class="px-4 py-3">
                                        <span class="status-badge status-${delivery.status}">
                                            ${statusMap[delivery.status]}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm">${new Date(delivery.created_at).toLocaleDateString('pt-BR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Driver - Minhas entregas
        async function loadDriverDeliveries() {
            try {
                const { data: deliveries } = await supabaseClient
                    .from('deliveries')
                    .select('*')
                    .eq('driver_id', currentUser.id)
                    .neq('status', 'entregue')
                    .order('created_at', { ascending: false });

                renderDriverDeliveries(deliveries || []);
            } catch (error) {
                console.error('Erro ao carregar entregas:', error);
            }
        }

        function renderDriverDeliveries(deliveries) {
            const driverDiv = document.getElementById('driverDeliveries');

            if (deliveries.length === 0) {
                driverDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma entrega pendente</p>';
                return;
            }

            driverDiv.innerHTML = deliveries.map(delivery => `
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-sm text-gray-600">C√≥digo</p>
                            <p class="font-mono font-bold text-lg">${delivery.tracking_code}</p>
                        </div>
                        <span class="status-badge status-${delivery.status}">
                            ${delivery.status === 'pendente' ? 'Pendente' : 'Em Rota'}
                        </span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <p><span class="font-semibold">Cliente:</span> ${delivery.customer_name}</p>
                        <p><span class="font-semibold">Telefone:</span> <a href="tel:${delivery.customer_phone}" class="text-blue-600 hover:underline">${delivery.customer_phone}</a></p>
                        <p><span class="font-semibold">Endere√ßo:</span> ${delivery.customer_address}</p>
                    </div>
                    
                    <!-- Bot√µes de Navega√ß√£o -->
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="openInGoogleMaps('${delivery.customer_address.replace(/'/g, "\\'")}')" 
                                class="bg-white border-2 border-blue-500 text-blue-600 px-4 py-2 rounded hover:bg-blue-50 flex items-center justify-center">
                            <i class="fas fa-map-marked-alt mr-2"></i>Google Maps
                        </button>
                        <button onclick="openInWaze('${delivery.customer_address.replace(/'/g, "\\'")}')" 
                                class="bg-white border-2 border-cyan-500 text-cyan-600 px-4 py-2 rounded hover:bg-cyan-50 flex items-center justify-center">
                            <i class="fas fa-route mr-2"></i>Waze
                        </button>
                    </div>
                    
                    <!-- Bot√µes de Status -->
                    <div class="flex gap-2">
                        ${delivery.status === 'pendente' ? `
                            <button onclick="updateDeliveryStatus('${delivery.id}', '${delivery.tracking_code}', 'em-rota')" 
                                    class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                <i class="fas fa-truck mr-2"></i>Iniciar Entrega
                            </button>
                        ` : `
                            <button onclick="openDeliveryModal('${delivery.id}', '${delivery.tracking_code}')" 
                                    class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>Confirmar Entrega
                            </button>
                            <button onclick="updateDeliveryStatus('${delivery.id}', '${delivery.tracking_code}', 'problema')" 
                                    class="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                <i class="fas fa-times mr-2"></i>Problema
                            </button>
                        `}
                    </div>
                </div>
            `).join('');
        }

        // Atualizar status
        async function updateDeliveryStatus(deliveryId, trackingCode, newStatus) {
            showLoading(true);

            try {
                const statusDescriptions = {
                    'em-rota': 'Saiu para entrega',
                    'entregue': 'Entregue ao destinat√°rio',
                    'problema': 'Problema na entrega - aguardando solu√ß√£o'
                };

                // Atualizar status
                const { error: updateError } = await supabaseClient
                    .from('deliveries')
                    .update({ status: newStatus })
                    .eq('id', deliveryId);

                if (updateError) throw updateError;

                // Adicionar ao hist√≥rico
                await supabaseClient
                    .from('delivery_updates')
                    .insert([{
                        delivery_id: deliveryId,
                        status: newStatus,
                        description: statusDescriptions[newStatus],
                        created_by: currentUser.id
                    }]);

                alert(`‚úÖ Status atualizado para: ${statusDescriptions[newStatus]}`);

                // Recarregar
                if (currentUserProfile.role === 'admin') {
                    await loadAllDeliveries();
                } else {
                    await loadDriverDeliveries();
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status');
            } finally {
                showLoading(false);
            }
        }

        // Fun√ß√µes de Navega√ß√£o
        function openInGoogleMaps(address) {
            // Codificar o endere√ßo para URL
            const encodedAddress = encodeURIComponent(address);
            
            // Detectar se √© mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // No mobile, tenta abrir o app do Google Maps
                window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            } else {
                // No desktop, abre em nova aba
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`, '_blank');
            }
        }

        function openInWaze(address) {
            // Codificar o endere√ßo para URL
            const encodedAddress = encodeURIComponent(address);
            
            // Detectar se √© mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // No mobile, tenta abrir o app do Waze
                window.location.href = `https://waze.com/ul?q=${encodedAddress}&navigate=yes`;
            } else {
                // No desktop, abre em nova aba
                window.open(`https://waze.com/ul?q=${encodedAddress}`, '_blank');
            }
        }

        // Fun√ß√µes do Modal de Confirma√ß√£o de Entrega
        function openDeliveryModal(deliveryId, trackingCode) {
            document.getElementById('modalDeliveryId').value = deliveryId;
            document.getElementById('modalTrackingCode').value = trackingCode;
            document.getElementById('deliveryConfirmModal').classList.remove('hidden');
            
            // Limpar formul√°rio
            document.getElementById('deliveryConfirmForm').reset();
            document.getElementById('modalDeliveryId').value = deliveryId;
            document.getElementById('modalTrackingCode').value = trackingCode;
        }

        function closeDeliveryModal() {
            document.getElementById('deliveryConfirmModal').classList.add('hidden');
            document.getElementById('deliveryConfirmForm').reset();
        }

        // M√°scara para documento (CPF ou RG)
        document.addEventListener('DOMContentLoaded', function() {
            const docInput = document.getElementById('receiverDocument');
            if (docInput) {
                docInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length <= 11) {
                        // Formatar como CPF: 000.000.000-00
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    } else {
                        // Limitar a 11 d√≠gitos (CPF)
                        value = value.substring(0, 11);
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    }
                    
                    e.target.value = value;
                });
            }
        });

        // Confirmar entrega com dados do recebedor
        async function confirmDelivery(event) {
            event.preventDefault();
            showLoading(true);

            try {
                const deliveryId = document.getElementById('modalDeliveryId').value;
                const trackingCode = document.getElementById('modalTrackingCode').value;
                const receiverName = document.getElementById('receiverName').value;
                const receiverRelation = document.getElementById('receiverRelation').value;
                const receiverDocument = document.getElementById('receiverDocument').value;
                const deliveryNotes = document.getElementById('deliveryNotes').value;

                // Validar campos obrigat√≥rios
                if (!receiverName || !receiverRelation || !receiverDocument) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios');
                    showLoading(false);
                    return;
                }

                // Atualizar status da entrega
                const { error: updateError } = await supabaseClient
                    .from('deliveries')
                    .update({ 
                        status: 'entregue',
                        received_by: receiverName,
                        receiver_relation: receiverRelation,
                        receiver_document: receiverDocument,
                        delivery_notes: deliveryNotes,
                        delivered_at: new Date().toISOString()
                    })
                    .eq('id', deliveryId);

                if (updateError) throw updateError;

                // Mapear rela√ß√£o para texto amig√°vel
                const relationMap = {
                    'titular': 'Titular (pr√≥prio cliente)',
                    'filho': 'Filho(a)',
                    'esposo': 'Esposo(a)',
                    'pai-mae': 'Pai/M√£e',
                    'irmao': 'Irm√£o/Irm√£',
                    'vizinho': 'Vizinho',
                    'porteiro': 'Porteiro/Zelador',
                    'funcionario': 'Funcion√°rio/Recepcionista',
                    'outros': 'Outros'
                };

                const relationText = relationMap[receiverRelation] || receiverRelation;

                // Adicionar ao hist√≥rico
                await supabaseClient
                    .from('delivery_updates')
                    .insert([{
                        delivery_id: deliveryId,
                        status: 'entregue',
                        description: `Entregue para: ${receiverName} (${relationText})`,
                        created_by: currentUser.id
                    }]);

                alert(`‚úÖ Entrega confirmada!\n\nRecebido por: ${receiverName}\nRela√ß√£o: ${relationText}`);

                // Fechar modal
                closeDeliveryModal();

                // Recarregar lista
                await loadDriverDeliveries();
            } catch (error) {
                console.error('Erro ao confirmar entrega:', error);
                alert('Erro ao confirmar entrega: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // ========== FUN√á√ïES DE IMPORTA√á√ÉO DE PLANILHAS ==========

        let importData = [];
        let validatedData = [];

        // Abrir modal de importa√ß√£o
        function openImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            resetImport();
        }

        // Fechar modal de importa√ß√£o
        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            resetImport();
        }

        // Reset do estado de importa√ß√£o
        function resetImport() {
            importData = [];
            validatedData = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden');
        }

        // Download template Excel
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ['Cliente', 'Telefone', 'Endere√ßo', 'Regi√£o', 'Entregador'],
                ['Jo√£o Silva', '(11) 98765-4321', 'Rua Exemplo, 123 - Centro, S√£o Paulo - SP', 'centro', 'Brazl'],
                ['Maria Santos', '(11) 91234-5678', 'Av. Teste, 456 - Zona Sul, S√£o Paulo - SP', 'zona-sul', 'Brazl']
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Definir largura das colunas
            ws['!cols'] = [
                {wch: 20}, // Cliente
                {wch: 18}, // Telefone
                {wch: 50}, // Endere√ßo
                {wch: 15}, // Regi√£o
                {wch: 15}  // Entregador
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Entregas');
            XLSX.writeFile(wb, 'template_importacao_lrb.xlsx');
        }

        // Manipular sele√ß√£o de arquivo
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);

            try {
                const data = await readExcelFile(file);
                
                if (data.length === 0) {
                    alert('Arquivo vazio ou formato inv√°lido');
                    showLoading(false);
                    return;
                }

                importData = data;
                await validateImportData(data);
                showPreview(file.name);
                
            } catch (error) {
                console.error('Erro ao ler arquivo:', error);
                alert('Erro ao ler arquivo: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Ler arquivo Excel/CSV
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Validar dados importados
        async function validateImportData(data) {
            validatedData = [];
            
            // Buscar lista de entregadores dispon√≠veis
            const { data: drivers } = await supabaseClient
                .from('user_profiles')
                .select('id, full_name')
                .eq('role', 'driver');

            const driverMap = {};
            drivers?.forEach(d => {
                driverMap[d.full_name.toLowerCase()] = d;
            });

            const validRegions = ['zona-norte', 'zona-sul', 'zona-leste', 'zona-oeste', 'centro'];

            data.forEach((row, index) => {
                const errors = [];
                
                // Normalizar nomes das colunas (case insensitive)
                const normalizedRow = {};
                Object.keys(row).forEach(key => {
                    const normalizedKey = key.toLowerCase().trim();
                    if (normalizedKey.includes('cliente')) normalizedRow.cliente = row[key];
                    else if (normalizedKey.includes('telefone')) normalizedRow.telefone = row[key];
                    else if (normalizedKey.includes('endere√ßo') || normalizedKey.includes('endereco')) normalizedRow.endereco = row[key];
                    else if (normalizedKey.includes('regi√£o') || normalizedKey.includes('regiao') || normalizedKey.includes('rota')) normalizedRow.regiao = row[key];
                    else if (normalizedKey.includes('entregador')) normalizedRow.entregador = row[key];
                });

                // Valida√ß√µes
                if (!normalizedRow.cliente || normalizedRow.cliente.trim() === '') {
                    errors.push('Cliente obrigat√≥rio');
                }
                
                if (!normalizedRow.telefone || normalizedRow.telefone.toString().trim() === '') {
                    errors.push('Telefone obrigat√≥rio');
                }
                
                if (!normalizedRow.endereco || normalizedRow.endereco.trim() === '') {
                    errors.push('Endere√ßo obrigat√≥rio');
                }
                
                if (!normalizedRow.regiao || !validRegions.includes(normalizedRow.regiao.toLowerCase().trim())) {
                    errors.push('Regi√£o inv√°lida');
                }
                
                const driverKey = normalizedRow.entregador ? normalizedRow.entregador.toLowerCase().trim() : '';
                const driver = driverMap[driverKey];
                
                if (!driver) {
                    errors.push('Entregador n√£o encontrado');
                }

                validatedData.push({
                    row: index + 1,
                    cliente: normalizedRow.cliente || '',
                    telefone: normalizedRow.telefone || '',
                    endereco: normalizedRow.endereco || '',
                    regiao: normalizedRow.regiao || '',
                    entregador: normalizedRow.entregador || '',
                    driver_id: driver?.id || null,
                    driver_name: driver?.full_name || null,
                    valid: errors.length === 0,
                    errors: errors
                });
            });
        }

        // Mostrar preview
        function showPreview(fileName) {
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('previewArea').classList.remove('hidden');

            const validCount = validatedData.filter(d => d.valid).length;
            const errorCount = validatedData.length - validCount;

            document.getElementById('fileName').textContent = fileName;
            document.getElementById('totalRows').textContent = validatedData.length;
            document.getElementById('validRows').textContent = validCount;
            document.getElementById('errorRows').textContent = errorCount;
            document.getElementById('importCount').textContent = validCount;

            const tbody = document.getElementById('previewTable');
            tbody.innerHTML = validatedData.map(item => `
                <tr class="${item.valid ? 'bg-green-50' : 'bg-red-50'}">
                    <td class="px-3 py-2 border">${item.row}</td>
                    <td class="px-3 py-2 border">${item.cliente}</td>
                    <td class="px-3 py-2 border">${item.telefone}</td>
                    <td class="px-3 py-2 border text-xs">${item.endereco}</td>
                    <td class="px-3 py-2 border">${item.regiao}</td>
                    <td class="px-3 py-2 border">${item.entregador}</td>
                    <td class="px-3 py-2 border text-xs">
                        ${item.valid ? 
                            '<span class="text-green-600"><i class="fas fa-check-circle"></i> OK</span>' : 
                            '<span class="text-red-600"><i class="fas fa-times-circle"></i> ' + item.errors.join(', ') + '</span>'
                        }
                    </td>
                </tr>
            `).join('');

            // Desabilitar bot√£o se n√£o houver linhas v√°lidas
            document.getElementById('importButton').disabled = validCount === 0;
        }

        // Processar importa√ß√£o
        async function processImport() {
            const validItems = validatedData.filter(d => d.valid);
            
            if (validItems.length === 0) {
                alert('Nenhuma linha v√°lida para importar');
                return;
            }

            if (!confirm(`Deseja importar ${validItems.length} entregas?`)) {
                return;
            }

            showLoading(true);

            let successCount = 0;
            let errorCount = 0;

            try {
                for (const item of validItems) {
                    try {
                        // Gerar c√≥digo de rastreamento
                        const { data: codeData } = await supabaseClient.rpc('generate_tracking_code');
                        const trackingCode = codeData;

                        // Inserir entrega
                        const { error } = await supabaseClient
                            .from('deliveries')
                            .insert([{
                                tracking_code: trackingCode,
                                customer_name: item.cliente,
                                customer_phone: item.telefone,
                                customer_address: item.endereco,
                                route: item.regiao,
                                driver_id: item.driver_id,
                                driver_name: item.driver_name,
                                status: 'pendente'
                            }]);

                        if (error) throw error;

                        // Criar primeiro update (s√≥ se a entrega foi criada com sucesso)
                        const { data: delivery } = await supabaseClient
                            .from('deliveries')
                            .select('id')
                            .eq('tracking_code', trackingCode)
                            .single();

                        if (delivery) {
                            await supabaseClient
                                .from('delivery_updates')
                                .insert([{
                                    delivery_id: delivery.id,
                                    status: 'pendente',
                                    description: 'Malote recebido na base',
                                    created_by: currentUser.id
                                }]);
                        }

                        successCount++;
                    } catch (error) {
                        console.error(`Erro na linha ${item.row}:`, error);
                        errorCount++;
                    }
                }

                // Mostrar resultado
                document.getElementById('previewArea').classList.add('hidden');
                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('successCount').textContent = successCount;
                
                if (errorCount > 0) {
                    document.getElementById('errorCount').textContent = `${errorCount} linhas com erro`;
                } else {
                    document.getElementById('errorCount').textContent = '';
                }

                // Recarregar lista de entregas
                await loadAllDeliveries();

            } catch (error) {
                console.error('Erro ao processar importa√ß√£o:', error);
                alert('Erro ao processar importa√ß√£o: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
